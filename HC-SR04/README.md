# STM32 HC-SR04 超声波测距驱动库

> 📏 基于输入捕获（Input Capture）或 GPIO + 定时器中断的高精度超声波测距驱动，适用于 HC-SR04 模块，测量范围 2cm ~ 400cm。 

## ✨ 核心特性

- ✅ 支持标准 **HC-SR04 超声波模块**
- ✅ 测量范围：**2 cm ～ 400 cm**（典型精度 ±3mm）
- ✅ 两种实现方式（取决于具体代码）：
  - **方式一**：使用 **定时器输入捕获（Input Capture）** 捕获 Echo 脉宽（高精度、低 CPU 占用）
  - **方式二**：使用 **GPIO 电平检测 + 微秒延时** 测量高电平持续时间（简单、无需复杂配置）
- ✅ 返回单位为 **厘米（cm）** 或 **微秒（µs）**（飞行时间）
- ✅ 自动处理 **超时保护**（无回波时返回错误值）
- ✅ 模块化设计：`hc-sr04.h` 声明接口，`hc-sr04.c` 实现逻辑

## 📁 文件结构

|             |                                                 |
| ----------- | ----------------------------------------------- |
| `hc-sr04.h` | 驱动头文件：引脚定义、函数声明、错误码          |
| `hc-sr04.c` | 驱动实现：触发信号发送、Echo 脉宽测量、距离计算 |

## ⚙️ 硬件连接

|      |                |                                         |
| ---- | -------------- | --------------------------------------- |
| VCC  | 5V             | **注意：HC-SR04 需要 5V 供电**          |
| GND  | GND            | 共地                                    |
| Trig | GPIO（如 PA0） | 输出：触发信号（10µs 高电平）           |
| Echo | GPIO（如 PA1） | 输入：回响信号（高电平持续时间 = 距离） |

> ⚠️ **电平兼容性**：
> STM32 是 3.3V 逻辑，而 HC-SR04 的 Echo 输出为 5V！
> **建议**：在 Echo 引脚加 **分压电阻**（如 10k + 20k）或使用 **电平转换器**，避免损坏 MCU。 

## 🔧 软件实现方式（根据常见设计）

### 方式 A：基于 **输入捕获（推荐）**

- 使用 **TIMx_CHy** 捕获 Echo 上升沿和下降沿

- 自动计算脉宽，精度高（可达 0.1µs）

- 示例 API：

  float distance = HC_SR04_GetDistance(); // 单位：cm

### 方式 B：基于 **GPIO + 延时检测**

- 发送 Trig 脉冲后，循环检测 Echo 引脚

- 使用 `delay_us()` 计数高电平时间

- 简单但占用 CPU，精度略低

- 示例：

  uint32_t echo_time = HC_SR04_ReadEcho(); // 单位：µs

  float distance = echo_time * 0.034 / 2;  // 声速 340 m/s

> 📌 您的 `hc-sr04.c` 很可能采用其中一种方式。**输入捕获方式更专业**，适合实时系统。 

## 📦 使用示例

\#include "hc-sr04.h"

int main(void)

{

​    HAL_Init();

​    SystemClock_Config();

​    

​    HC_SR04_Init(); // 初始化 Trig/Echo 引脚（及定时器，若使用输入捕获）

​    while (1) {

​        float dist = HC_SR04_GetDistance();

​        if (dist >= 0) {

​            printf("Distance: %.1f cm\n", dist);

​        } else {

​            printf("Measurement timeout!\n");

​        }

​        HAL_Delay(500); // HC-SR04 建议测量间隔 ≥ 60ms

​    }

}

## ⏱️ 时序要求

- **Trig 信号**：至少 **10 µs** 的高电平脉冲
- **测量周期**：建议 **≥ 60ms**（即每秒不超过 15 次），避免声波串扰
- **Echo 脉宽**：最大约 **38ms**（对应 400cm）

## 📌 注意事项

1. **供电电压**：HC-SR04 **必须使用 5V 供电**，3.3V 工作不稳定。
2. **电平保护**：Echo 输出 5V，**切勿直接连 STM32 GPIO**！
3. **测量盲区**：最近有效距离约 **2~3 cm**。
4. **环境影响**：高温、吸音材料、斜面障碍物会影响精度。
5. **多模块干扰**：多个 HC-SR04 同时工作会互相干扰，需分时测量。

## 📐 距离计算原理

超声波在空气中传播速度约为 **340 m/s = 0.034 cm/µs**。
距离公式：

距离（cm） = （Echo 高电平时间 µs） × 0.034 ÷ 2

> ÷2 是因为声波走了“往返”路程。 

## 📄 返回值说明

- **正常**：返回 `float` 类型距离（单位 cm）
- **超时/错误**：返回 **负值**（如 `-1`）或特定错误码（见 `hc-sr04.h`）

## 📦 依赖

- STM32 HAL 库（`HAL_GPIO`, `HAL_TIM`）
- 若使用延时方式：需 `delay_us()` 支持（如您之前上传的 `delay.c`）
- 若使用输入捕获：需配置对应定时器通道

## 🎯 典型应用场景

- 智能小车避障
- 液位/物位检测
- 机器人防碰撞
- 停车辅助系统（模型级）

## 📄 许可证

GPL 3.0

> 💡 **提示**：为提高稳定性，建议在实际项目中**多次测量取平均值**（如连续测 3~5 次）。 